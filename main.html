<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="main.css" />

<title>CEEThip</title>
  <style>
      .state-login header .question {
        display: none;  
      }
      .state-login .page.home-page {
        display: block;  
      }
      .state-home .page.main-page {
        display: block;  
      }
      .state-my-question .page.myquestion {
        display: block;  
      }
      .state-question .page.q-page {
        display: block;  
      }

      
  </style>

</head>


<body onload="getUserdata()" class="state-login">
<!-- <body> -->
<!--header part -->

    <header>
      <div class="logo">CEEThip<span>.</span></div>
      <div class="question">
        <h3 id="user-name"></h3>
        <button id = "CreatQuestion" onclick="goBack()">Back</button>
        <button id = "MyQuestion" onclick="showQuestionFromMQ()">My Question</button>
      </div>
    </header>

<!-- home part-->
    <div id="login">
    <div class="page home-page">
      <style>
          .home{
              padding: 1.5rem 7%;
              display: flex;
              align-items: center;
              min-height: 80vh;
              background-size: cover;
              background-position: center;
          }
          .home .content{
              width: 70%;
          }
          .home .content h3{
              font-size: 5rem;
              color:#333;
          }
          .home .content span{
              text-align: center;
              font-size: 2.5rem;
              color:var(--pink);
              padding:1rem 0;
              line-height: 1.8;
          }
          .home .content p{
              font-size: 2rem;
              color:rgb(123, 122, 122);
              padding: 1rem 0;
              line-height: 1.5;
          }
          .home input{
              width: 45rem;
              padding: 12px 20px;
              margin: 8px 0;
              display: inline-block;
              border: 1px solid grey;
              border-radius: 4px;
              box-sizing: border-box;
              align-items: center;
          }
          .image img{
              width: 70rem;
              height: auto;
              align-items: center;
          }
      </style>
      
      <section class="home" id="home">

        <div class="content">
            <h3>Welcome to CEEThip<span>.</span></h3>
            <span>question and answer platform that help students with online learning</span>
            <p>แพลต์ฟอร์มเว็บบอร์ดที่ให้นักเรียนสามารถตั้งกระทู้ถามข้อสงสัยเกี่ยวกับรายวิชา 
                และสามารถให้อาจารย์หรือนักเรียนคนอื่นเข้ามาตอบคำถามได้ </p>
            <p>ถ้าอยากเป็นส่วนหนึ่งกับเรา โปรดใส่ชื่อ</p>
            
            <!-- <form  style="align-items: center; " autocorrect="off" spellcheck="false" autocomplete="off"> -->
                <input autocorrect="off" spellcheck="false" autocomplete="off" type="text" class = "nnninputusername" id="name"  placeholder="Your name.." onkeyup="checkUser();" >
                <button onclick="changeUsername(); ">Enter</button>
            <!-- </form> -->
            <p style="color: red;font-size: small;" id="userAlert"></p>
        </div>
      
        <div class="image">
            <img src="working3.png" alt="Working images">
        </div>
    </div>
  </div>


</section>

<!-- web board part -->

    <div class = "page main-page">
      
      <section id="{{SUBJECT}}" class = "subject hide " >
        <div style="display: flex; align-items: center;">
          <img src="idea-icon.png" alt="bulb" style="height: 5rem;">
          <h3 class="title capital">{{SUBJECT}}<span>.</span></h3>
          <span style="width:70%;" class="spacer"></span>
          <img src="search_icon.png" style="height: 4rem;padding-top: 5px;padding-right: 5px;">
          <span style="width:30%;"> <input class="txt-search" onkeyup="searchBySubject('{{SUBJECT}}')" style="margin-top: 10px;width: 100%;font-size: large;" id="search-text" type="text" placeholder="search your question..."></span>
        </div>
        
        <br> 
        <table class="tab-data">
            <thead>
              <tr class="head-table upper">
                <th class="q-header">Question</th>
                <th>Reply</th>
                <th>Username</th>
              </tr>
            </thead>
          <tbody> 
            <tr id="Q{{QUESTION-ID}}" class="hide" onclick = "showQuestion('{{QUESTION-ID}}');">
              <td class="q-icon">
                  <img src = "question-mark.svg" style="padding-right: 15px;width: 42px; ">
                  <span>{{QUESTION}}</span>
                  <!-- <a href="page3-Math.html" class = "q-a" style="left:0px">{{QUESTION}}</a> -->
              </td>
              <td>{{REPLY}}</td>
              <td>{{AUTHOR}}</td>
            </tr>
          </tbody>
        </table>
        <div class="add-question" style="display: flex; align-items: center;">
          <input class="question-title" type = "text"  placeholder="Create your question...">
          <textarea class="question-detail" type = "text"  placeholder="Detail here..."></textarea>
          <button onclick="AddQuestion('{{SUBJECT}}')">Create</button>
        </div>
        
      </section>
      <div id="subjectData"></div>
      <section class="add-subject">
        <img src="add-icon.png" alt="Add subject">
        <input class="subject-add" type = "text"  placeholder="Add Subject..."><button onclick="AddSubject();">Submit</button>
      </section> 
    </div>
    

<!-- answer part -->

    <div class = "page q-page">
      <style>
        button:hover{
          background:#e84393;
        }
        textarea{
            margin-top:15px;
            padding: 15px 15px;
            resize: none;
            width: 100%;
        }
      </style>
      <section>
        <div style="display: flex; align-items: center;">
          <img src="idea-icon.png" alt="bulb" style="height: 5rem;">
          <h2 class="title capital" id="q_subject">{{SUBJECT}}</h2>
        </div>
        <hr style="margin-bottom: -10px; border: 1px solid grey;">
      </section>

      <section style="background-color: #eef6ee; background-clip: content-box;">
        <div class="section-title">
          <img src = "question-mark.svg" style="width: 42px;" >
          <span id="q_text" style="font-size: 3rem;">{{QUESTION_TEXT}}</span>
        </div>
        <br>
        
        <p class="paraQuestion" id="q_detail" style="font-size: 1.7rem; text-align: justify;
        vertical-align: top;">{{QUESTION_DETAIL}}</p>
        <h3 style="text-align: right; font-size:1.5rem;" id="q_author">{{AUTHOR}}</h3>
        <hr style="border: 1px solid grey; width: 100%;"/>
      </section>
          
      <section id = "detail">
        <h2 class="section-answer" style="font-size:2rem;">Reply:</h2>
        <textarea id="ansTextInput" name="answer" rows="5" cols="90" placeholder="Reply..."></textarea>
        <button style="margin-top: 0.5rem; border-radius: 5rem; background:#333;
        color:#fff; padding:.5rem 3.5rem;cursor: pointer; font-size: 1.5rem;
        float: right;" onclick="AddAnswer()">Submit</button>
      </section>

      <br>

      <section id ="ReplyList">
        <table class = "ans-template hide" id = "mrtable" style="table-layout: fixed;font-family:Arial, Helvetica, sans-serif; 
        font-size: 1.5rem; position: relative; border-radius: 4px;border: 1px solid; 
        text-align: left;margin-bottom: 20px;width:100%;">
          <thead>
            <th id = "math" style=" height: 30px;
            font-size: larger; padding-left: 10px;
            background-color: rgba(197, 243, 243, 0.333);
            padding-bottom: 0px; width: 75%;">Ans</th>
            <th id = "muth" style="background-color: rgb(197, 243, 243);
            text-align: right; padding-right: 10px;">{{ANS-AUTHOR}}</th>
          </thead>
            
          <tbody>
            <td id = "matd" style = "font-size: large; padding: 10px; text-align: left; margin: 10px;" colspan="2" ><p>{{ANS-TEXT}}</p></tr>
          </tbody>
        </table>
        <div class="data"></div>
      </section>

    </div> 

<!-- my question part-->
    <div class="page myquestion">
      <style>
        #mqatd:hover{
          color:#e84393;
        }
      </style>
    <section>
      <h3 class="title-MyQuestion" style="font-size: 3rem;">MyQuestion<span style="color:#e84393">.</span></h3>
      <hr>
    </section >
    

    <section>
      
      <table id = "mqrtable" class="hide" style="table-layout: fixed;font-family:Arial, Helvetica, sans-serif; border-top: 1px solid;
      text-align: left; margin-bottom: 20px;width:100%;">
        <!-- question -->
        <tbody>
          <tr id="Q{{QUESTION-ID}}" class="myq " onclick = "showQuestion('{{QUESTION-ID}}');">
            <td class="q-icon">
                <img src = "question-mark.svg" style="padding-right: 15px;width: 42px; ">
                <span>{{QUESTION}}</span>
                <!-- <a href="page3-Math.html" class = "q-a" style="left:0px">{{QUESTION}}</a> -->
            </td>
            <td>{{REPLY}}</td>
            <td>{{AUTHOR}}</td>
          </tr>
        </tbody>
        
        
      </table>
      <table  style="table-layout: fixed;font-family:Arial, Helvetica, sans-serif; border-top: 1px solid;
      text-align: left; margin-bottom: 20px;width:100%;">
        <thead>
          <tr class="head-table">
            <th class="q-header">Question</th>
            <th>Reply</th>
            <th>Username</th>
          </tr>
        </thead>
        <tbody class="myquestionData">

        </tbody>
      </table>
      
      
             
    </section>
    
  </div>
  <div class="modal" id="modalAlert">
    <!-- Modal content -->
    <div class="modal-content">
     <div class="modal-header">
       <span class="close">&times;</span>
       <!-- <h2>Modal Header</h2> -->
     </div>
     <div class="modal-body">
       <p class="txtmodal" style="font-size: large;text-align: center;">Some text in the Modal Body</p>
       <!-- <p>Some other text...</p> -->
       <!-- <input type="text" value="12134"> -->
       
     </div>
     <div class="modal-footer">
       <!-- <h3>Modal Footer</h3> -->
       <p style="font-size: large;text-align: center;">
          <button class="commit" style="margin: auto;">OK</button>
        </p>
     </div>
   </div>  
  </div>
  
<!-- javascript part-->

<script type="module" src ="home.js"></script>    
<script>
     
var userName = "";
var gQuestion = {};
var gID ;
var allUsers = {};
var gSearchData = {};

const checkbox = document.querySelector(".nnninputusername");

function MakeModal(selector){
  var modal = document.querySelector(selector);
  var span = modal.querySelector(".close");
  var commit = modal.querySelector(".commit");
  span.onclick = function() {
      modal.hide();
  }
  commit.onclick = function(){
    modal.hide(true);
  }

  modal._show = function(resolve){
    modal.style.display = "block";
    modal.resolve = resolve;
  }
  modal.show = async function(){
    return new Promise(function(resolve, reject) {
      // the function is executed automatically when the promise is constructed

      // after 1 second signal that the job is done with the result "done"
      //setTimeout(() => resolve("done"), 1000);
      modal._show((x)=>resolve(x));
    });    
    modal.style.display = "block";
  }
  modal.hide = function(commit = false){
    modal.style.display = "none";
    if(modal.resolve){
        modal.resolve(commit);
    }
  }

  return modal;
}


function UICreateSubject(subject)
{
    console.log(subject);
    var section = document.querySelector("section.subject");
    var newSection = section.cloneNode(true);
    newSection.classList.remove("hide");
    var strHTML = newSection.outerHTML;
    strHTML = strHTML.replaceAll("{{SUBJECT}}",subject);
    
    var body = document.querySelector("#subjectData");
    body.insertAdjacentHTML('beforeend', strHTML );
}

function UICreateQuestion(subject,question,reply,author,qID){
  console.log("UICreateQuestion",subject,question,reply,author,qID);
    var tbody = document.querySelector("#" + subject + " .tab-data tbody");
    var tr = tbody.querySelector(".hide");

    var newTr = tr.cloneNode(true);
    newTr.classList.remove("hide");


    var strHTML = newTr.outerHTML;
    strHTML = strHTML.replaceAll("{{QUESTION}}",question);
    strHTML = strHTML.replaceAll("{{REPLY}}",reply);
    strHTML = strHTML.replaceAll("{{AUTHOR}}",author);
    strHTML = strHTML.replaceAll("{{QUESTION-ID}}",qID);

    tbody.insertAdjacentHTML('beforeend', strHTML );
    
    console.log(tr);
}
function UICreateQuestioninQPAGE(subject,question,reply,author,qID){
  console.log("UICreateQuestioninQPAGE",subject,question,reply,author,qID);
    var tr = document.querySelector("#mqrtable .myq");
    // var tr = tbody.querySelector(".mqr");
    console.log("tr",tr);

    var newTr = tr.cloneNode(true);
    // newTr.classList.remove("hide");

    console.log(">>>>>>newTr UICreateQuestioninQPAGE", newTr);
    var strHTML = newTr.outerHTML;
    console.log("bef>>>>>>strHTML UICreateQuestioninQPAGE", strHTML);
    strHTML = strHTML.replaceAll("{{QUESTION}}",question);
    strHTML = strHTML.replaceAll("{{REPLY}}",reply);
    strHTML = strHTML.replaceAll("{{AUTHOR}}",author);
    strHTML = strHTML.replaceAll("{{QUESTION-ID}}",qID);
    console.log(">>>>>>strHTML UICreateQuestioninQPAGE", strHTML);
    // myquestionData
    // document.querySelector("#myquestionData ")
    var addplace = document.querySelector(".myquestionData ")
    console.log("addplace",addplace);
    addplace.insertAdjacentHTML('beforeend', strHTML );
    // addplace.innerHTML = strHTML;
    
    
    
}

async function AddSubject(){
  var subject = document.querySelector(".subject-add").value;
  subject = subject.trim();
  if(subject != ""){
    // var flag = false;
    var subjects = await getallsubject();
    for(var item in subjects){
      if(subject.toLowerCase() == item.toLowerCase()){
        UIAlert("วิชานี้มีอยู่เเล้ว เเหกตาดูก่อนนน");
        return;
      }
    }
    // subjects.forEach((doc) => {
    //   if(subject.toLowerCase() == doc.data().name.toLowerCase()){
    //     flag = true;
    //   }
    // });
    // if(flag == true){
    //   UIAlert("วิชานี้มีอยู่เเล้ว เเหกตาดูก่อนนน");
    //   return;
    // }
    await addsubject({subject:subject});
    UICreateSubject(subject);
    document.querySelector(".subject-add").value = "";
  }else{
    UIAlert("Enter your new subject first!!!!");
  }

}
async function AddQuestion(subject){
    var title = document.querySelector("#" + subject + " .question-title").value;
    var detail = document.querySelector("#" + subject + " .question-detail").value;
    title = title.trim();
    detail = detail.trim();
    if( title != ""){
    
      console.log(title,detail);
      var x = await addquestion({question_txt:title,subject:subject,detail:detail,author:userName});
      console.log(x);
      UICreateQuestion(subject,title,0,userName,x);
      document.querySelector("#" + subject + " .question-title").value = "";
      document.querySelector("#" + subject + " .question-detail").value = "";

      // รหัสไรงะ
      // showQuestion(this);

      }else{
      UIAlert("Enter your question first!!!!")
    }   
}

function UICreateAnswer(obj){
    // var ans_arr = document.querySelector("#ReplyList");
    // console.log(ans_arr);
    
    var ans_template = document.querySelector("#ReplyList .ans-template ");
    console.log(ans_template);

    var ans = ans_template.cloneNode(true);
    ans.classList.remove("hide");


    var strHTML = ans.outerHTML;
    strHTML = strHTML.replaceAll("{{ANS-TEXT}}",obj.text);
    strHTML = strHTML.replaceAll("{{ANS-AUTHOR}}",obj.author);

    var addplace = document.querySelector("#ReplyList .data");
    console.log(addplace);
    addplace.insertAdjacentHTML('beforeend', strHTML );
    
    console.log(ans_template);
}
function AddAnswer(){
    var ans_text = document.querySelector("#ansTextInput").value;
    ans_text = ans_text.trim();
    if(ans_text !=""){
      console.log(ans_text);
      addanswer({question_id:gID,author:userName,anstext:ans_text});
      UICreateAnswer({text:ans_text,author:userName});
      document.querySelector("#ansTextInput").value = "";
    }else{
      UIAlert("enter your answer first!!!!")
    }
    
    
}
async function getUserdata(){ 
  var users = await getalluser();
  console.log("getUserdata",users);
  allUsers = users;
}

function checkUser(){
  console.log("checkUser");
  var name = document.querySelector(".nnninputusername").value;
  name = name.trim();
  console.log(name)
  if(name in allUsers){
    console.log("in");
    document.querySelector("#userAlert").innerHTML = `there is already user in this name. continue if you are ${name}`;
    // userAlert
    // console.log(`there is already user in this name. continue if you are ${name}` )
  }
  else{
    document.querySelector("#userAlert").innerHTML = '';
  }

 
}

function searchBySubject(subject){
  var searchText  = document.querySelector("#" + subject + " .txt-search").value;
  console.log("searchBySubject",subject,searchText);
  var data = gSearchData[subject];
  searchText = searchText.trim().toUpperCase();

  var trs = document.querySelectorAll("#" + subject + " .tab-data tbody tr");
  console.log(trs);
  for(var i =0;i< trs.length;i++){
    //console.log(i);
    if(i == 0) continue;
    trs[i].classList.remove("hide");
  }
  if(searchText != ""){
    for(var i in data){
        var text = data[i].text + " " + data[i].detail;
        if (text.toUpperCase().indexOf(searchText) < 0) { 
          //console.log(i);
          document.querySelector("#Q" + i).classList.add("hide");
        }
    }
  }

}

function goBack(){
  var prevState = getCurrentState();
  var stateTab = {
    "state-home":"state-login",
    "state-my-question":"state-home",
    "state-question":"state-home",
  }
  if(stateTab[prevState] != undefined){
    if(stateTab[prevState] == "state-home"){
        onload();
    }
    changeState(stateTab[prevState],prevState);
    
  }else{
    console.log("goBack","unknown prevstate","prevState");
  }
}
function getCurrentState(){
  return document.querySelector("body").className;
}

function changeState(toState,fromState)
{
  document.querySelector("body").classList.remove(fromState);
  document.querySelector("body").classList.add(toState);
}

function toHomefromlogin(){
  console.log("toHomefromlogin");
  onload();
  changeState("state-home","state-login");
}

async function showQuestionFromMQ(){
  await loadQuestionFromAuthor(userName);
  changeState("state-my-question","state-home");
  
}

async function showQuestion(qID){

    gID = qID;
    console.log("showQuestion", qID);
    var question=await getquestion({question_id:qID});
    question = {subject:'N/A',text:'N/A',detail:'N/A',author:'N/A', ... question};
    UIClearAnswer();
    var answers = question.ans;
    for(var ans in answers){
        console.log("ans", answers[ans]);
        UICreateAnswer(answers[ans]);
    }
    document.querySelector("#q_subject").innerHTML = question.subject;    
    document.querySelector("#q_text").innerHTML = question.text;
    document.querySelector("#q_detail").innerHTML = question.detail;
    document.querySelector("#q_author").innerHTML = question.author;
    changeState("state-question",getCurrentState());    
}

function UIClearAnswer(){
    var ans_arr = document.querySelector(" #ReplyList .data");
    ans_arr.innerHTML = '';
    // console.log(ans_template);
}

async function loadSubject(){
  var subjects = await getallsubject();
  console.log("test()",subjects);  
  var searchData = {};
  for(var item in subjects){
      UICreateSubject(item);
      var questions = await getallquestion({
          subject:item,
      });
      console.log(item,questions);
      searchData[item] = questions;
      for(var q in questions){
         var question = questions[q];
         question = { ans:[],author:Date.now(), ... question};
         UICreateQuestion(question.subject,question.text,question.ans.length,question.author,q);
      }
  }
  gSearchData = searchData;
  
}
async function loadQuestionFromAuthor(name){
  var questions = await getallquestionfromauthor({author:name});
  console.log("loadQuestionFromAuthor()",questions);  
  document.querySelector(".myquestionData ").innerHTML = '';
  for(var q in questions){
    var question = questions[q];
    UICreateQuestioninQPAGE(question.subject,question.text,question.ans.length,question.author,q);
  }
}

function refresh(){
  console.log("refresh");
  loadSubject();
}
function onload(){
  console.log("onload");
  // login
  document.querySelector("#subjectData").innerHTML = '';
  
  //set user name 
  document.querySelector("#user-name").innerHTML = userName;
  
  loadSubject();
}
function changeUsername(){
  var name = document.querySelector(".nnninputusername").value;
  name = name.trim();
  if(name != ""){
    
    userName = name;
    adduser({user:userName});
    console.log(userName,"  name", name);
    localStorage.setItem("CEEThip", name);
    toHomefromlogin();
  }
  else{
    UIAlert("enter your username first!!!!");
  }
}
async function UIAlert(msg){
  console.log("UIAlert",msg);
  // alert(msg);
  gAlert.querySelector(".txtmodal").innerHTML = msg;
  await gAlert.show();

  
}
var gAlert = MakeModal("#modalAlert");
var prevUser = localStorage.getItem("CEEThip");
if(prevUser != null){
  document.querySelector("#name").value = prevUser;
}

</script>
</body>
</html>